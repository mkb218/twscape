<!--
Copyright 2011, Google Inc.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

    * Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.
    * Redistributions in binary form must reproduce the above
copyright notice, this list of conditions and the following disclaimer
in the documentation and/or other materials provided with the
distribution.
    * Neither the name of Google Inc. nor the names of its
contributors may be used to endorse or promote products derived from
this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="description" content="Create custom drum beats with a few clicks.  Choose from 15 drum kits and 26 effects, and adjust the pitch of each drum.  Save and share your beatsâ€¦ rock on!">
<title>twscape</title>


<script language="javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript" src="Queue.js" language="javascript"></script>
<!-- Our javascript code -->
<script type="text/javascript">

// Events
// init() once the page has finished loading.
window.onload = init;
//alert('outer scope');

var search_url_front = 'http://search.twitter.com/search.json?include_entities=true&result_type=recent&callback=?&q='
var eventQ;
var customSamps = new Array();
var intensityceiling = 1;
var tenp = 0;
var twelvep = 0;
var fourteenp = 0;

var context;
// var convolver;
// var compressor;
var masterGainNode;
// var effectLevelNode;

// Each effect impulse response has a specific overall desired dry and wet volume.
// For example in the telephone filter, it's necessary to make the dry volume 0 to correctly hear the effect.
var effectDryMix = 1.0;
var effectWetMix = 1.0;

var timeoutId;

var startTime;
var lastDrawTime = -1;

var kits;

var kNumInstruments = 16;
var kInitialKitIndex = 0;
var kMaxSwing = .08;

var currentKit;

var instruments = ['Kick', 'Snare', 'HiHat', 'Tom1', 'Tom2', 'Tom3'];

var volumes = [0, 0.3, 1];

var kitCount = 0;

var kitName = [
    "twscape"
    ];

var kitNamePretty = [
    "twscape"
    ];

function Kit(name) {
    this.name = name;

    this.pathName = function() {
        return "audio/";
    };

    this.intensityBuffers = new Array(12);
    this.thunderBuffer = 0;
    this.dropBuffer = 0;
    this.hashBuffer = 0;

    this.instrumentCount = kNumInstruments;
    this.instrumentLoadCount = 0;
    
    this.startedLoading = false;
    this.isLoaded = false;
    
    this.demoIndex = -1;
}

Kit.prototype.setDemoIndex = function(index) {
    this.demoIndex = index;
}

Kit.prototype.load = function() {
    if (this.startedLoading)
        return;
        
    this.startedLoading = true;
        
    var pathName = this.pathName();

    var intensitysub = pathName + "intensity";
    var thunderPath = pathName + "thunder.wav";
    var hashPath = pathName + "hash.wav";
    var dropPath = pathName + "drop.wav";
    var dropletsPath = pathName + "droplets.wav";

    this.loadSample(0, dropletsPath, false);
    this.loadSample(1, intensitysub+"0_10.wav", false);
    this.loadSample(2, intensitysub+"0_12.wav", false);
    this.loadSample(3, intensitysub+"0_14.wav", false);
    this.loadSample(4, intensitysub+"1_10.wav", false);
    this.loadSample(5, intensitysub+"1_12.wav", false);
    this.loadSample(6, intensitysub+"1_14.wav", false);
    this.loadSample(7, intensitysub+"2_10.wav", false);
    this.loadSample(8, intensitysub+"2_12.wav", false);
    this.loadSample(9, intensitysub+"2_14.wav", false);
    this.loadSample(10, intensitysub+"3_10.wav", false);
    this.loadSample(11, intensitysub+"3_12.wav", false);
    this.loadSample(12, intensitysub+"3_14.wav", false);
    this.loadSample(13, thunderPath, false);
    this.loadSample(14, hashPath, false);
    this.loadSample(15, dropPath, false);
}

Kit.prototype.loadSample = function(sampleID, url, mixToMono) {
    // Load asynchronously

    var request = new XMLHttpRequest();
    request.open("GET", url, true);
    request.responseType = "arraybuffer";

    var kit = this;

    // alert("loading a sample");
    request.onload = function() {
        var buffer = context.createBuffer(request.response, mixToMono);
        if (sampleID <= 12) {
            kit.intensityBuffers[sampleID] = buffer;
        } else {
            switch (sampleID) {
                case 13: kit.thunderBuffer = buffer; break;
                case 14: kit.hashBuffer = buffer; break;
                case 15: kit.dropBuffer = buffer; break;
            }
        }

        kit.instrumentLoadCount++;
        // alert("loaded a sample");
        if (kit.instrumentLoadCount == kit.instrumentCount) {
            // alert("loaded");
            kit.isLoaded = true;
            document.getElementById('loading').innerHTML = "loaded all buffers";
            tenp = loopPlayer(currentKit.intensityBuffers[0], false, 0, 0, 0, 0, 0.3, 1, 0);
            twelvep = loopPlayer(currentKit.intensityBuffers[0], false, 0, 0, 0, 0, 0.3, 1, 0);
            fourteenp = loopPlayer(currentKit.intensityBuffers[0], false, 0, 0, 0, 0, 0.3, 1, 0);

            if (kit.demoIndex != -1) {
                beatDemo[kit.demoIndex].setKitLoaded();
            }
        }
    }

    request.send();
}

var impulseResponseInfoList = [
    // Impulse responses - each one represents a unique linear effect.
    {"name":"No Effect", "url":"undefined", "dryMix":1, "wetMix":0},
    {"name":"Spreader 1", "url":"impulse-responses/spreader50-65ms.wav",        "dryMix":0.8, "wetMix":1.4},
    {"name":"Spreader 2", "url":"impulse-responses/noise-spreader1.wav",        "dryMix":1, "wetMix":1},
    {"name":"Spring Reverb", "url":"impulse-responses/feedback-spring.wav",     "dryMix":1, "wetMix":1},
    {"name":"Space Oddity", "url":"impulse-responses/filter-rhythm3.wav",       "dryMix":1, "wetMix":0.7},
    {"name":"Reverse", "url":"impulse-responses/spatialized5.wav",              "dryMix":1, "wetMix":1},
    {"name":"Huge Reverse", "url":"impulse-responses/matrix6-backwards.wav",    "dryMix":0, "wetMix":0.7},
    {"name":"Telephone Filter", "url":"impulse-responses/filter-telephone.wav", "dryMix":0, "wetMix":1.2},
    {"name":"Lopass Filter", "url":"impulse-responses/filter-lopass160.wav",    "dryMix":0, "wetMix":0.5},
    {"name":"Hipass Filter", "url":"impulse-responses/filter-hipass5000.wav",   "dryMix":0, "wetMix":4.0},
    {"name":"Comb 1", "url":"impulse-responses/comb-saw1.wav",                  "dryMix":0, "wetMix":0.7},
    {"name":"Comb 2", "url":"impulse-responses/comb-saw2.wav",                  "dryMix":0, "wetMix":1.0},
    {"name":"Cosmic Ping", "url":"impulse-responses/cosmic-ping-long.wav",      "dryMix":0, "wetMix":0.9},
    {"name":"Kitchen", "url":"impulse-responses/house-impulses/kitchen-true-stereo.wav", "dryMix":1, "wetMix":1},
    {"name":"Living Room", "url":"impulse-responses/house-impulses/dining-living-true-stereo.wav", "dryMix":1, "wetMix":1},
    {"name":"Living-Bedroom", "url":"impulse-responses/house-impulses/living-bedroom-leveled.wav", "dryMix":1, "wetMix":1},
    {"name":"Dining-Far-Kitchen", "url":"impulse-responses/house-impulses/dining-far-kitchen.wav", "dryMix":1, "wetMix":1},
    {"name":"Medium Hall 1", "url":"impulse-responses/matrix-reverb2.wav",      "dryMix":1, "wetMix":1},
    {"name":"Medium Hall 2", "url":"impulse-responses/matrix-reverb3.wav",      "dryMix":1, "wetMix":1},
    {"name":"Large Hall", "url":"impulse-responses/spatialized4.wav",           "dryMix":1, "wetMix":0.5},
    {"name":"Peculiar", "url":"impulse-responses/peculiar-backwards.wav",       "dryMix":1, "wetMix":1},
    {"name":"Backslap", "url":"impulse-responses/backslap1.wav",                "dryMix":1, "wetMix":1},
    {"name":"Warehouse", "url":"impulse-responses/tim-warehouse/cardiod-rear-35-10/cardiod-rear-levelled.wav", "dryMix":1, "wetMix":1},
    {"name":"Diffusor", "url":"impulse-responses/diffusor3.wav",                "dryMix":1, "wetMix":1},
    {"name":"Binaural Hall", "url":"impulse-responses/bin_dfeq/s2_r4_bd.wav",   "dryMix":1, "wetMix":0.5},
    {"name":"Huge", "url":"impulse-responses/matrix-reverb6.wav",               "dryMix":1, "wetMix":0.7},
]

var impulseResponseList = 0;

function ImpulseResponse(url, index) {
    this.url = url;
    this.index = index;
    this.startedLoading = false;
    this.isLoaded_ = false;
    this.buffer = 0;
    
    this.demoIndex = -1; // no demo
}

ImpulseResponse.prototype.setDemoIndex = function(index) {
    this.demoIndex = index;
}

ImpulseResponse.prototype.isLoaded = function() {
    return this.isLoaded_;
}

ImpulseResponse.prototype.load = function() {
    if (this.startedLoading) {
        return;
    }
    
    this.startedLoading = true;

    // Load asynchronously
    var request = new XMLHttpRequest();
    request.open("GET", this.url, true);
    request.responseType = "arraybuffer";
    this.request = request;
    
    var asset = this;

    request.onload = function() {
        asset.buffer = context.createBuffer(request.response, false);
        asset.isLoaded_ = true;
        
        if (asset.demoIndex != -1) {
            beatDemo[asset.demoIndex].setEffectLoaded();
        }
    }

    request.send();
}

function startLoadingAssets() {
    impulseResponseList = new Array();

    for (i = 0; i < impulseResponseInfoList.length; i++) {
        impulseResponseList[i] = new ImpulseResponse(impulseResponseInfoList[i].url, i);
    }
    
    // Initialize drum kits
    var numKits = kitName.length;
    kits = new Array(numKits);
    for (var i  = 0; i < numKits; i++) {
        kits[i] = new Kit(kitName[i]);
    }  
    
    // Start loading the assets used by the presets first, in order of the presets.
/*    for (var demoIndex = 0; demoIndex < 5; ++demoIndex) {
        var effect = impulseResponseList[beatDemo[demoIndex].effectIndex];
        var kit = kits[beatDemo[demoIndex].kitIndex];
        
        // These effects and kits will keep track of a particular demo, so we can change
        // the loading status in the UI.
        effect.setDemoIndex(demoIndex);
        kit.setDemoIndex(demoIndex);
        
        effect.load();
        kit.load();
    }
  */  
    // Then load the remaining assets.
    // Note that any assets which have previously started loading will be skipped over.
    for (var i  = 0; i < numKits; i++) {
        kits[i].load();
    }  

    // Start at 1 to skip "No Effect"
    for (i = 1; i < impulseResponseInfoList.length; i++) {
        impulseResponseList[i].load();
    }
    
    // Setup initial drumkit
    currentKit = kits[0];
    
}


// This gets rid of the loading spinner in each of the demo buttons.
// function showDemoAvailable(demoIndex /* zero-based */) {
//     var url = demoButtonURL(demoIndex);
//     var n = demoIndex + 1;
//     var demoName = "demo" + n;
//     var demo = document.getElementById(demoName);
//     demo.src = url;
//     
//     // Enable play button and assign it to demo 2.
//     if (demoIndex == 1) {
//         showPlayAvailable();
//         loadBeat(beatDemo[1]);
// 
//     // Uncomment to allow autoplay
//     //     handlePlay();
//     }
// }

// This gets rid of the loading spinner on the play button.
function showPlayAvailable() {
    var play = document.getElementById("play");
    play.src = "images/btn_play.png";
}

function init() {
    // alert("init");
    // Let the beat demos know when all of their assets have been loaded.
    // Add some new methods to support this.
    // for (var i = 0; i < beatDemo.length; ++i) {
    //     beatDemo[i].index = i;
    //     beatDemo[i].isKitLoaded = false;
    //     beatDemo[i].isEffectLoaded = false;
    // 
    //     beatDemo[i].setKitLoaded = function() {
    //         this.isKitLoaded = true;
    //         this.checkIsLoaded();
    //     };
    // 
    //     beatDemo[i].setEffectLoaded = function() {
    //         this.isEffectLoaded = true;
    //         this.checkIsLoaded();
    //     };
    // 
    //     beatDemo[i].checkIsLoaded = function() {
    //         if (this.isLoaded()) {
    //             showDemoAvailable(this.index); 
    //         }
    //     };
    // 
    //     beatDemo[i].isLoaded = function() {
    //         return this.isKitLoaded && this.isEffectLoaded;
    //     };
    // }
        
    // alert("loading assets");
    startLoadingAssets();

    context = new webkitAudioContext();

    var finalMixNode = context.destination;

    // Create master volume.
    masterGainNode = context.createGainNode();
    masterGainNode.gain.value = 0.7; // reduce overall volume to avoid clipping
    masterGainNode.connect(finalMixNode);

    // Create effect volume.
    // effectLevelNode = context.createGainNode();
    // effectLevelNode.gain.value = 1.0; // effect level slider controls this
    // effectLevelNode.connect(masterGainNode);

    // Create convolver for effect
    // convolver = context.createConvolver();
    // convolver.connect(effectLevelNode);

    eventQ = new Queue();
//    initControls();
//    updateControls();
    // alert("init end");
    schedule();
    refreshTwitter();
}

function CustomSamp(path) {
    this.buffer = 0;
    this.isLoaded = 0;
    this.path = path;
}

CustomSamp.prototype.load = function() {
    // Load asynchronously

    var request = new XMLHttpRequest();
    request.open("GET", this.path, true);
    request.responseType = "arraybuffer";

    var samp = this;

    request.onload = function() {
        samp.buffer = context.createBuffer(request.response, 1);
        samp.isLoaded = true;
    }

    request.send();
}

function initControls() {
    // Initialize note buttons
    initButtons();
    makeKitList();
    makeEffectList();

    // sliders
    document.getElementById('effect_thumb').addEventListener('mousedown', handleSliderMouseDown, true);
    document.getElementById('tom1_thumb').addEventListener('mousedown', handleSliderMouseDown, true);
    document.getElementById('tom2_thumb').addEventListener('mousedown', handleSliderMouseDown, true);
    document.getElementById('tom3_thumb').addEventListener('mousedown', handleSliderMouseDown, true);
    document.getElementById('hihat_thumb').addEventListener('mousedown', handleSliderMouseDown, true);
    document.getElementById('snare_thumb').addEventListener('mousedown', handleSliderMouseDown, true);
    document.getElementById('kick_thumb').addEventListener('mousedown', handleSliderMouseDown, true);
    document.getElementById('swing_thumb').addEventListener('mousedown', handleSliderMouseDown, true);

    document.getElementById('effect_thumb').addEventListener('dblclick', handleSliderDoubleClick, true);
    document.getElementById('tom1_thumb').addEventListener('dblclick', handleSliderDoubleClick, true);
    document.getElementById('tom2_thumb').addEventListener('dblclick', handleSliderDoubleClick, true);
    document.getElementById('tom3_thumb').addEventListener('dblclick', handleSliderDoubleClick, true);
    document.getElementById('hihat_thumb').addEventListener('dblclick', handleSliderDoubleClick, true);
    document.getElementById('snare_thumb').addEventListener('dblclick', handleSliderDoubleClick, true);
    document.getElementById('kick_thumb').addEventListener('dblclick', handleSliderDoubleClick, true);
    document.getElementById('swing_thumb').addEventListener('dblclick', handleSliderDoubleClick, true);

    // tool buttons
    document.getElementById('play').addEventListener('mousedown', handlePlay, true);
    document.getElementById('stop').addEventListener('mousedown', handleStop, true);
    document.getElementById('save').addEventListener('mousedown', handleSave, true);
    document.getElementById('save_ok').addEventListener('mousedown', handleSaveOk, true);
    document.getElementById('load').addEventListener('mousedown', handleLoad, true);
    document.getElementById('load_ok').addEventListener('mousedown', handleLoadOk, true);
    document.getElementById('load_cancel').addEventListener('mousedown', handleLoadCancel, true);
    document.getElementById('reset').addEventListener('mousedown', handleReset, true);
    document.getElementById('demo1').addEventListener('mousedown', handleDemoMouseDown, true);
    document.getElementById('demo2').addEventListener('mousedown', handleDemoMouseDown, true);
    document.getElementById('demo3').addEventListener('mousedown', handleDemoMouseDown, true);
    document.getElementById('demo4').addEventListener('mousedown', handleDemoMouseDown, true);
    document.getElementById('demo5').addEventListener('mousedown', handleDemoMouseDown, true);

    var elBody = document.getElementById('body');
    elBody.addEventListener('mousemove', handleMouseMove, true);
    elBody.addEventListener('mouseup', handleMouseUp, true);

    document.getElementById('tempoinc').addEventListener('mousedown', tempoIncrease, true);
    document.getElementById('tempodec').addEventListener('mousedown', tempoDecrease, true);
}

function initButtons() {        
    var elButton;

    for (i = 0; i < loopLength; ++i) {
        for (j = 0; j < kNumInstruments; j++) {
                elButton = document.getElementById(instruments[j] + '_' + i);
                elButton.addEventListener("mousedown", handleButtonMouseDown, true);
        }
    }
}

function makeEffectList() {
    var elList = document.getElementById('effectlist');
    var numEffects = impulseResponseInfoList.length;

    
    var elItem = document.createElement('li');
    elItem.innerHTML = 'None';
    elItem.addEventListener("mousedown", handleEffectMouseDown, true);
    
    for (var i = 0; i < numEffects; i++) {
        var elItem = document.createElement('li');
        elItem.innerHTML = impulseResponseInfoList[i].name;
        elList.appendChild(elItem);
        elItem.addEventListener("mousedown", handleEffectMouseDown, true);
    }
}

function makeKitList() {
    var elList = document.getElementById('kitlist');
    var numKits = kitName.length;
    
    for (var i = 0; i < numKits; i++) {
        var elItem = document.createElement('li');
        elItem.innerHTML = kitNamePretty[i];
        elList.appendChild(elItem);
        elItem.addEventListener("mousedown", handleKitMouseDown, true);
    }
}

function advanceNote() {
    // Advance time by a 16th note...
    var secondsPerBeat = 60.0 / theBeat.tempo;

    rhythmIndex++;
    if (rhythmIndex == loopLength) {
        rhythmIndex = 0;
    }

        // apply swing    
    if (rhythmIndex % 2) {
        noteTime += (0.25 + kMaxSwing * theBeat.swingFactor) * secondsPerBeat;
    } else {
        noteTime += (0.25 - kMaxSwing * theBeat.swingFactor) * secondsPerBeat;
    }
}

function playNote(buffer, pan, x, y, z, sendGain, mainGain, playbackRate, noteTime) {
    // Create the note
    var voice = context.createBufferSource();
    voice.buffer = buffer;
    voice.playbackRate.value = playbackRate;
    
    // Connect to main mix
    var dryGainNode = context.createGainNode();
    dryGainNode.gain.value = mainGain;
    voice.connect(dryGainNode);

    dryGainNode.connect(masterGainNode);

    voice.noteOn(noteTime);
}

function loopPlayer(buffer, pan, x, y, z, sendGain, mainGain, playbackRate, noteTime) {
    // Create the note
    var voice = context.createBufferSource();
    voice.buffer = buffer;
    voice.playbackRate.value = playbackRate;
    voice.loop = true;

    // Optionally, connect to a panner
    var dryGainNode = context.createGainNode();
    dryGainNode.gain.value = mainGain;
    voice.connect(dryGainNode);

    dryGainNode.connect(masterGainNode);

    voice.noteOn(noteTime);
    return voice;
}

var lastintensity=0;
function schedule() {
//    console.log("schedule!");
    var a = 5;
    var b = -0.25;
    var c = -0.5;
    var floor = 0;
    var sleepy = 5;
    var intensitylevel = lastintensity;
    if (!eventQ.isEmpty()) {
        console.log("events in queue");
        sleepy = a*Math.exp(b*eventQ.getLength()+c) + floor;
        console.log("sleep time", sleepy);
        var e = eventQ.dequeue();
        document.getElementById('qsize').innerHTML = eventQ.getLength();
        console.log("event type", e);
        var x = Math.random() * 4 - 2;
        var y = Math.random() * 4 - 2;
        var z = Math.random() * 4 - 2;
        var loop = false;
        // set intensity level compared to current ceiling and change rainplayers
        if (1/sleepy > intensityceiling) {
            intensityceiling = 1/sleepy;
        }
        intensitylevel = Math.floor((1/sleepy) / (intensityceiling/6))+1;
        console.log("ceil", intensityceiling);
        if (intensitylevel != lastintensity) {
            if (intensitylevel > lastintensity) {
                intensitylevel = lastintensity + 1;
            } else {
                intensitylevel = lastintensity - 1;
            }
            console.log("intense", intensitylevel, "last", lastintensity);
        }
        if (e == "#") {
            playNote(currentKit.hashBuffer, false, 0, 0, 0, 0, 0.5, 1, 0);
        } else if (e == "@") {
            playNote(currentKit.thunderBuffer, false, 0, 0, 0, 0, 0.5, 1, 0);
        } else if (e == "d") {
            playNote(currentKit.dropBuffer, false, 0, 0, 0, 0, 0.5, 1, 0);
        } else if (customSamps[e].isLoaded) {
            playNote(customSamps[e].buffer, false, 0, 0, 0, 0, 0.5, 1, 0);
        }
            
    } else if (tenp != 0) {
        console.log("decrement");
        intensitylevel = lastintensity - 1;
        if (intensitylevel < 0) {
            intensitylevel = 0;
        }
    }
    
    if (intensitylevel != lastintensity) {
        tenp.loop = true;
        twelvep.loop = true;
        fourteenp.loop = true;
        switch (intensitylevel) {
            case 0:
                tenp.buffer = currentKit.intensityBuffers[0];tenp.noteOn(0);
                twelvep.noteOff(1);
                fourteenp.noteOff(2);
                break;
            case 1:
                tenp.buffer = currentKit.intensityBuffers[1]; tenp.noteOn(0);
                setTimeout("twelvep.buffer = currentKit.intensityBuffers[0]; twelvep.noteOn(0);", 1000);
                setTimeout("fourteenp.noteOff(0)",2000);
                break;
            case 2:
                tenp.buffer = currentKit.intensityBuffers[4]; tenp.noteOn(0);
                setTimeout("twelvep.buffer = currentKit.intensityBuffers[1]; twelvep.noteOn(1);", 1000);
                setTimeout("fourteenp.noteOff(2);",2000);
                break;
            case 3:
                tenp.buffer = currentKit.intensityBuffers[7]; tenp.noteOn(0);
                setTimeout("twelvep.buffer = currentKit.intensityBuffers[5]; twelvep.noteOn(1);",1000);
                setTimeout("fourteenp.buffer = currentKit.intensityBuffers[3]; fourteenp.noteOn(2);", 2000);
                break;
            case 4:
                tenp.buffer = currentKit.intensityBuffers[10]; tenp.noteOn(0);
                setTimeout("twelvep.buffer = currentKit.intensityBuffers[8]; twelvep.noteOn(1);",1000);
                setTimeout("fourteenp.buffer = currentKit.intensityBuffers[6]; fourteenp.noteOn(2);", 2000);
                break;
            case 5:
                tenp.buffer = currentKit.intensityBuffers[10]; tenp.noteOn(0);
                setTimeout("twelvep.buffer = currentKit.intensityBuffers[11]; twelvep.noteOn(1);",1000);
                setTimeout("fourteenp.buffer = currentKit.intensityBuffers[9]; fourteenp.noteOn(2);", 2000);
                break;
            case 6:
            case 7:
                tenp.buffer = currentKit.intensityBuffers[10]; tenp.noteOn(0);
                setTimeout("twelvep.buffer = currentKit.intensityBuffers[11]; twelvep.noteOn(1);", 1000);
                setTimeout("fourteenp.buffer = currentKit.intensityBuffers[12]; fourteenp.noteOn(2);", 2000);
                break;
        }
        lastintensity = intensitylevel;
    }
    var timeoutId = setTimeout("schedule()", sleepy*1000);
}

function tempoIncrease() {
    theBeat.tempo = Math.min(kMaxTempo, theBeat.tempo+4);
    document.getElementById('tempo').innerHTML = theBeat.tempo;
}

function tempoDecrease() {
    theBeat.tempo = Math.max(kMinTempo, theBeat.tempo-4);
    document.getElementById('tempo').innerHTML = theBeat.tempo;
}

function handleSliderMouseDown(event) {
    mouseCapture = event.target.id;

    // calculate offset of mousedown on slider
    var el = event.target;
    if (mouseCapture == 'swing_thumb') {
        var thumbX = 0;    
        do {
            thumbX += el.offsetLeft;
        } while (el = el.offsetParent);

        mouseCaptureOffset = event.pageX - thumbX;
    } else {
        var thumbY = 0;    
        do {
            thumbY += el.offsetTop;
        } while (el = el.offsetParent);

        mouseCaptureOffset = event.pageY - thumbY;
    }
}

function handleSliderDoubleClick(event) {
    var id = event.target.id;
    if (id != 'swing_thumb' && id != 'effect_thumb') {
        mouseCapture = null;
        sliderSetValue(event.target.id, 0.5);
        updateControls();
    }
}

function handleMouseMove(event) {
    if (!mouseCapture) return;
    
    var elThumb = document.getElementById(mouseCapture);
    var elTrack = elThumb.parentNode;

    if (mouseCapture != 'swing_thumb') {
        var thumbH = elThumb.clientHeight;
        var trackH = elTrack.clientHeight;
        var travelH = trackH - thumbH;

        var trackY = 0;
        var el = elTrack;
        do {
            trackY += el.offsetTop;
        } while (el = el.offsetParent);

        var offsetY = Math.max(0, Math.min(travelH, event.pageY - mouseCaptureOffset - trackY));
        var value = 1.0 - offsetY / travelH;
        elThumb.style.top = travelH * (1.0 - value) + 'px';
    } else {
        var thumbW = elThumb.clientWidth;
        var trackW = elTrack.clientWidth;
        var travelW = trackW - thumbW;

        var trackX = 0;
        var el = elTrack;
        do {
            trackX += el.offsetLeft;
        } while (el = el.offsetParent);

        var offsetX = Math.max(0, Math.min(travelW, event.pageX - mouseCaptureOffset - trackX));
        var value = offsetX / travelW;
        elThumb.style.left = travelW * value + 'px';
    }

    sliderSetValue(mouseCapture, value);
}

function handleMouseUp() {
    mouseCapture = null;
}

function sliderSetValue(slider, value) {
    var pitchRate = Math.pow(2.0, 2.0 * (value - 0.5));
    
    switch(slider) {
    case 'effect_thumb':
        // Change the volume of the convolution effect.
        theBeat.effectMix = value;
        setEffectLevel(theBeat);            
        break;
    case 'kick_thumb':
        theBeat.kickPitchVal = value;
        kickPitch = pitchRate;
        break;
    case 'snare_thumb':
        theBeat.snarePitchVal = value;
        snarePitch = pitchRate;
        break;
    case 'hihat_thumb':
        theBeat.hihatPitchVal = value;
        hihatPitch = pitchRate;
        break;
    case 'tom1_thumb':
        theBeat.tom1PitchVal = value;
        tom1Pitch = pitchRate;
        break;
    case 'tom2_thumb':
        theBeat.tom2PitchVal = value;
        tom2Pitch = pitchRate;
        break;
    case 'tom3_thumb':
        theBeat.tom3PitchVal = value;
        tom3Pitch = pitchRate;
        break;
    case 'swing_thumb':
        theBeat.swingFactor = value;
        break; 
    }
}

function sliderSetPosition(slider, value) {
    var elThumb = document.getElementById(slider);
    var elTrack = elThumb.parentNode;

    if (slider == 'swing_thumb') {
        var thumbW = elThumb.clientWidth;
        var trackW = elTrack.clientWidth;
        var travelW = trackW - thumbW;

        elThumb.style.left = travelW * value + 'px';
    } else {
        var thumbH = elThumb.clientHeight;
        var trackH = elTrack.clientHeight;
        var travelH = trackH - thumbH;

        elThumb.style.top = travelH * (1.0 - value) + 'px';
    }
}

function handleButtonMouseDown(event) {
    var notes = theBeat.rhythm1;
    
    var instrumentIndex;
    var rhythmIndex;

    var elId = event.target.id;
    rhythmIndex = elId.substr(elId.indexOf('_') + 1, 2);
    instrumentIndex = instruments.indexOf(elId.substr(0, elId.indexOf('_')));
        
    switch (instrumentIndex) {
        case 0: notes = theBeat.rhythm1; break;
        case 1: notes = theBeat.rhythm2; break;
        case 2: notes = theBeat.rhythm3; break;
        case 3: notes = theBeat.rhythm4; break;
        case 4: notes = theBeat.rhythm5; break;
        case 5: notes = theBeat.rhythm6; break;
    }

    notes[rhythmIndex] = (notes[rhythmIndex] + 1) % 3;

    drawNote(notes[rhythmIndex], rhythmIndex, instrumentIndex);

    var note = notes[rhythmIndex];
    
    if (note) {
        switch(instrumentIndex) {
        case 0:  // Kick
          playNote(currentKit.kickBuffer, false, 0,0,-2, 0.5 * theBeat.effectMix, volumes[note] * 1.0, kickPitch, 0);
          break;

        case 1:  // Snare
          playNote(currentKit.snareBuffer, false, 0,0,-2, theBeat.effectMix, volumes[note] * 0.6, snarePitch, 0);
          break;

        case 2:  // Hihat
          // Pan the hihat according to sequence position.
          playNote(currentKit.hihatBuffer, true, 0.5*rhythmIndex - 4, 0, -1.0, theBeat.effectMix, volumes[note] * 0.7, hihatPitch, 0);
          break;

        case 3:  // Tom 1   
          playNote(currentKit.tom1, false, 0,0,-2, theBeat.effectMix, volumes[note] * 0.6, tom1Pitch, 0);
          break;

        case 4:  // Tom 2   
          playNote(currentKit.tom2, false, 0,0,-2, theBeat.effectMix, volumes[note] * 0.6, tom2Pitch, 0);
          break;

        case 5:  // Tom 3   
          playNote(currentKit.tom3, false, 0,0,-2, theBeat.effectMix, volumes[note] * 0.6, tom3Pitch, 0);
          break;
        }
    }
}

function handleKitComboMouseDown(event) {
    document.getElementById('kitcombo').classList.toggle('active');
}

function handleKitMouseDown(event) {
    var index = kitNamePretty.indexOf(event.target.innerHTML);
    theBeat.kitIndex = index;
    currentKit = kits[index];
    document.getElementById('kitname').innerHTML = kitNamePretty[index];
}

function handleBodyMouseDown(event) {
    var elKitcombo = document.getElementById('kitcombo');
    var elEffectcombo = document.getElementById('effectcombo');

    if (elKitcombo.classList.contains('active') && !isDescendantOfId(event.target, 'kitcombo_container')) {
        elKitcombo.classList.remove('active');
        if (!isDescendantOfId(event.target, 'effectcombo_container')) {
            event.stopPropagation();
        }
    }
    
    if (elEffectcombo.classList.contains('active') && !isDescendantOfId(event.target, 'effectcombo')) {
        elEffectcombo.classList.remove('active');
        if (!isDescendantOfId(event.target, 'kitcombo_container')) {
            event.stopPropagation();
        }
    }    
}

function isDescendantOfId(el, id) {
    if (el.parentElement) {
        if (el.parentElement.id == id) {
            return true;
        } else {
            return isDescendantOfId(el.parentElement, id);
        }
    } else {
        return false;
    }
}

function handleEffectComboMouseDown(event) {
    if (event.target.id != 'effectlist') {
        document.getElementById('effectcombo').classList.toggle('active');
    }
}

function handleEffectMouseDown(event) {
    for (var i = 0; i < impulseResponseInfoList.length; ++i) {
        if (impulseResponseInfoList[i].name == event.target.innerHTML) {

            // Hack - if effect is turned all the way down - turn up effect slider.
            // ... since they just explicitly chose an effect from the list.
            if (theBeat.effectMix == 0)
                theBeat.effectMix = 0.5;

            setEffect(i);
            break;
        }
    }
}

function setEffect(index) {
    if (index > 0 && !impulseResponseList[index].isLoaded()) {
        alert('Sorry, this effect is still loading.  Try again in a few seconds :)');
        return;
    }

    theBeat.effectIndex = index;
    effectDryMix = impulseResponseInfoList[index].dryMix;
    effectWetMix = impulseResponseInfoList[index].wetMix;            
    convolver.buffer = impulseResponseList[index].buffer;

  // Hack - if the effect is meant to be entirely wet (not unprocessed signal)
  // then put the effect level all the way up.
    if (effectDryMix == 0)
        theBeat.effectMix = 1;

    setEffectLevel(theBeat);
    sliderSetValue('effect_thumb', theBeat.effectMix);
    updateControls();

    document.getElementById('effectname').innerHTML = impulseResponseInfoList[index].name;
}

function setEffectLevel() {        
    // Factor in both the preset's effect level and the blending level (effectWetMix) stored in the effect itself.
    effectLevelNode.gain.value = theBeat.effectMix * effectWetMix;
}


function handleDemoMouseDown(event) {
    var loaded = false;
    
    switch(event.target.id) {
        case 'demo1':
            loaded = loadBeat(beatDemo[0]);    
            break;
        case 'demo2':
            loaded = loadBeat(beatDemo[1]);    
            break;
        case 'demo3':
            loaded = loadBeat(beatDemo[2]);    
            break;
        case 'demo4':
            loaded = loadBeat(beatDemo[3]);    
            break;
        case 'demo5':
            loaded = loadBeat(beatDemo[4]);    
            break;
    }
    
    if (loaded)
        handlePlay();
}

function handlePlay(event) {
    noteTime = 0.0;
    startTime = context.currentTime + 0.005;
    schedule();

    document.getElementById('play').classList.add('playing');
    document.getElementById('stop').classList.add('playing');
}

function handleStop(event) {
    clearTimeout(timeoutId);

    var elOld = document.getElementById('LED_' + (rhythmIndex + 14) % 16);
    elOld.src = 'images/LED_off.png';

    rhythmIndex = 0;

    document.getElementById('play').classList.remove('playing');
    document.getElementById('stop').classList.remove('playing');
}

function handleSave(event) {
    toggleSaveContainer();
    var elTextarea = document.getElementById('save_textarea');
    elTextarea.value = JSON.stringify(theBeat);
}

function handleSaveOk(event) {
    toggleSaveContainer();
}

function handleLoad(event) {
    toggleLoadContainer();
}

function handleLoadOk(event) {
    var elTextarea = document.getElementById('load_textarea');
    theBeat = JSON.parse(elTextarea.value);

    // Set drumkit
    currentKit = kits[theBeat.kitIndex];
    document.getElementById('kitname').innerHTML = kitNamePretty[theBeat.kitIndex];

    // Set effect
    setEffect(theBeat.effectIndex);

    // Change the volume of the convolution effect.
    setEffectLevel(theBeat);

    // Apply values from sliders
    sliderSetValue('effect_thumb', theBeat.effectMix);
    sliderSetValue('kick_thumb', theBeat.kickPitchVal);
    sliderSetValue('snare_thumb', theBeat.snarePitchVal);
    sliderSetValue('hihat_thumb', theBeat.hihatPitchVal);
    sliderSetValue('tom1_thumb', theBeat.tom1PitchVal);
    sliderSetValue('tom2_thumb', theBeat.tom2PitchVal);
    sliderSetValue('tom3_thumb', theBeat.tom3PitchVal);
    sliderSetValue('swing_thumb', theBeat.swingFactor);

    // Clear out the text area post-processing
    elTextarea.value = '';

    toggleLoadContainer();
    updateControls();
}

function handleLoadCancel(event) {
    toggleLoadContainer();
}

function toggleSaveContainer() {
    document.getElementById('pad').classList.toggle('active');
    document.getElementById('params').classList.toggle('active');
    document.getElementById('tools').classList.toggle('active');
    document.getElementById('save_container').classList.toggle('active');
}

function toggleLoadContainer() {
    document.getElementById('pad').classList.toggle('active');
    document.getElementById('params').classList.toggle('active');
    document.getElementById('tools').classList.toggle('active');
    document.getElementById('load_container').classList.toggle('active');
}

function handleReset(event) {
    handleStop();
    loadBeat(beatReset);    
}

function loadBeat(beat) {
    // Check that assets are loaded.
    if (beat != beatReset && !beat.isLoaded())
        return false;

    handleStop();

    theBeat = cloneBeat(beat);
    currentKit = kits[theBeat.kitIndex];
    setEffect(theBeat.effectIndex);

    // apply values from sliders
    sliderSetValue('effect_thumb', theBeat.effectMix);
    sliderSetValue('kick_thumb', theBeat.kickPitchVal);
    sliderSetValue('snare_thumb', theBeat.snarePitchVal);
    sliderSetValue('hihat_thumb', theBeat.hihatPitchVal);
    sliderSetValue('tom1_thumb', theBeat.tom1PitchVal);
    sliderSetValue('tom2_thumb', theBeat.tom2PitchVal);
    sliderSetValue('tom3_thumb', theBeat.tom3PitchVal);
    sliderSetValue('swing_thumb', theBeat.swingFactor);

    updateControls();

    return true;
}

function updateControls() {
    for (i = 0; i < loopLength; ++i) {
        for (j = 0; j < kNumInstruments; j++) {
            switch (j) {
                case 0: notes = theBeat.rhythm1; break;
                case 1: notes = theBeat.rhythm2; break;
                case 2: notes = theBeat.rhythm3; break;
                case 3: notes = theBeat.rhythm4; break;
                case 4: notes = theBeat.rhythm5; break;
                case 5: notes = theBeat.rhythm6; break;
            }

            drawNote(notes[i], i, j);
        }
    }

    document.getElementById('kitname').innerHTML = kitNamePretty[theBeat.kitIndex];
    document.getElementById('effectname').innerHTML = impulseResponseInfoList[theBeat.effectIndex].name;
    document.getElementById('tempo').innerHTML = theBeat.tempo;
    sliderSetPosition('swing_thumb', theBeat.swingFactor);
    sliderSetPosition('effect_thumb', theBeat.effectMix);
    sliderSetPosition('kick_thumb', theBeat.kickPitchVal);
    sliderSetPosition('snare_thumb', theBeat.snarePitchVal);
    sliderSetPosition('hihat_thumb', theBeat.hihatPitchVal);
    sliderSetPosition('tom1_thumb', theBeat.tom1PitchVal);        
    sliderSetPosition('tom2_thumb', theBeat.tom2PitchVal);
    sliderSetPosition('tom3_thumb', theBeat.tom3PitchVal);
}


function drawNote(draw, xindex, yindex) {    
    var elButton = document.getElementById(instruments[yindex] + '_' + xindex);
    switch (draw) {
        case 0: elButton.src = 'images/button_off.png'; break;
        case 1: elButton.src = 'images/button_half.png'; break;
        case 2: elButton.src = 'images/button_on.png'; break;
    }
}

function drawPlayhead(xindex) {
    var lastIndex = (xindex + 15) % 16;

    var elNew = document.getElementById('LED_' + xindex);
    var elOld = document.getElementById('LED_' + lastIndex);
    
    elNew.src = 'images/LED_on.png';
    elOld.src = 'images/LED_off.png';
}

var max_id = 0;
var refresher = 0;
function refreshTwitter() {
//    alert("refresh");
    if (refresher != 0) {
        clearTimeout(refresher); // avoid making second loop after force refresh
    }
    var search_url = search_url_front + document.getElementById('searchterm').value;
    console.log(search_url);
    $.getJSON( search_url, function(json) {
	 var i, j;
        var at_sign = /@/g;
	 if( json.results ) {
          

	   for( i = 0; i < json.results.length; i++ ) {
	       if (json.results[i].id <= max_id) {
	           continue;
           }
           console.log(json.results[i].text );
           max_id = json.results[i].id;
	     
         eventQ.enqueue('d');
         console.log("tweet!");
	     // the text parameter can be searched for this too
	     // find hashtags
	     if( ( json.results[ i ].entities ) && ( json.results[ i ].entities.hashtags ) && ( json.results[ i ].entities.hashtags.length > 0 ) ) {
	       for( j = 0; j < json.results[i].entities.hashtags.length; j++ ) {  
	         eventQ.enqueue( '#' );
	         console.log("hash!");
	       }
	     }
	   
	     // find mentions
	     // FIXME: should add one '@' for EACH
	     //   now just adds one regardless of how many mentions are in the tweet
	     if( at_sign.test( json.results[i].text ) ) {
	       var matches = json.results[i].text.match(at_sign);
	       var k;
	       for (k = 0; k < matches.length; k++) {
	           eventQ.enqueue( '@' );
    	         console.log("reply!");
           }
	     }
	   }
	   document.getElementById('qsize').innerHTML = eventQ.getLength();
	 }

     });
     refresher = setTimeout("refreshTwitter()", 5000);
 }
    
function loadCustom(event, url) {
    customSamps[event] = new CustomSamp(url);
    customSamps[event].load();
}

</script>
</head>


<!-- Preload some important UI elements -->
<!--  The markup below keeps all images in a row on a single long line to avoid 
            a bizarre bug where otherwise the browser inserts an extra pixel between 
            the images.  The cost of perfectionism :O{
-->

<body id='body'>
    <p id="loading">Loading...</p>
    <p>Event Queue size: <span id="qsize">0</span></p>
    <form><input type="button" name="tweet" value="Tweet" onClick="eventQ.enqueue('d')" /><br />
    <input type="button" name="hash" value="Hashtag" onClick="eventQ.enqueue('#')" /><br />
    <input type="button" name="reply" value="Reply" onClick="eventQ.enqueue('@')" /><br/>
    <input id="searchterm" type="text" name="searchterm" /><input type="button" name="refresh" value="Refresh Twitter" onClick="refreshTwitter()" /><br />
    <input id="matchterm0" type="text" name="matchterm0" /><input id="url0" type="text" name="url0" /><input type="button" name="refresh" value="Load" id="button0" onClick="loadCustom(document.getElementById('matchterm0').value, document.getElementById('url0').value)" /><br />
    </form>
</body>
</html>
